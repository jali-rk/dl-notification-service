databaseChangeLog:
  - changeSet:
      id: 001-01-create-notification-channel-enum
      author: system
      preConditions:
        - onFail: MARK_RAN
        - sqlCheck:
            expectedResult: 0
            sql: SELECT COUNT(*) FROM pg_type WHERE typname = 'notification_channel'
      changes:
        - sql:
            sql: CREATE TYPE notification_channel AS ENUM ('IN_APP','EMAIL','WHATSAPP')
  - changeSet:
      id: 001-01-create-delivery-status-enum
      author: system
      preConditions:
        - onFail: MARK_RAN
        - sqlCheck:
            expectedResult: 0
            sql: SELECT COUNT(*) FROM pg_type WHERE typname = 'delivery_status'
      changes:
        - sql:
            sql: CREATE TYPE delivery_status AS ENUM ('PENDING','SENT','FAILED')
  - changeSet:
      id: 001-02-create-notifications-parent
      author: system
      changes:
        - sql:
            sql: |
              CREATE TABLE IF NOT EXISTS notifications (
                id UUID NOT NULL,
                user_id UUID NOT NULL,
                channel VARCHAR(20) NOT NULL,
                title VARCHAR(500) NOT NULL,
                body TEXT NOT NULL,
                is_read BOOLEAN NOT NULL DEFAULT FALSE,
                read_at TIMESTAMP NULL,
                delivery_status VARCHAR(20) NOT NULL DEFAULT 'PENDING',
                template_key VARCHAR(100) NULL,
                metadata JSONB NULL,
                created_at TIMESTAMP NOT NULL,
                updated_at TIMESTAMP NOT NULL,
                PRIMARY KEY (user_id, id, created_at)
              ) PARTITION BY RANGE (created_at);
  - changeSet:
      id: 001-03-indexes-parent
      author: system
      changes:
        - sql:
            sql: |
              -- Parent indexes created as templates; partitions will have their own
              CREATE INDEX IF NOT EXISTS idx_notifications_user_channel ON notifications (user_id, channel, created_at);
              CREATE INDEX IF NOT EXISTS idx_notifications_user_is_read ON notifications (user_id, is_read, created_at);
              CREATE INDEX IF NOT EXISTS idx_notifications_created_at ON notifications (created_at);
